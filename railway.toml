[build]
builder = "nixpacks"
buildCommand = "npm install --production=false && npm run build"

[deploy]
startCommand = "npm run db:deploy && npm start"
healthcheckPath = "/api/healthcheck"
healthcheckTimeout = 100
restartPolicyType = "on_failure"
numReplicas = 1

[deploy.websocket]
enabled = true
path = ["/ws", "/websocket"]
timeout = 300
keepAlive = true
maxConnections = 1000
idleTimeout = 120
proxyProtocol = false
forwardedHeaderFields = ["Upgrade", "Connection", "Sec-WebSocket-Key", "Sec-WebSocket-Version", "Sec-WebSocket-Extensions"]
streamProxy = true
handleUpgrade = true
enableWebsocket = true

[metrics]
enabled = true
path = "/metrics"

[deploy.env]
NODE_ENV = "production"
TZ = "UTC"
RAILWAY_WEBSOCKET_PROXY = "true"

[service]
internal_port = 8080
auto_stop_machines = false
auto_start_machines = true
min_machines_running = 1

[[headers]]
path = ["/ws", "/websocket"]
  [headers.values]
  Connection = ["Upgrade"]
  Upgrade = ["websocket"]
  Sec-WebSocket-Version = ["13"]